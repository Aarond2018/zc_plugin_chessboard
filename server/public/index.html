<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Socket.IO</title>
  </head>

  <body>
    <h1>Chess Game Room</h1>
    <h3 id="game-id"></h3>
    <div>
      <button id="create-game">create game</button>
      <button id="join-game">join game</button>
      <input type="text" id="join-game-input" style="display: none" />
      <button id="Ok-btn" style="display: none">Ok</button>
    </div>

    <!-- Update -->
    <h2 id="update"></h2>

    <div>
      <input type="text" id="move-input" />
      <button id="send-btn">send</button>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/centrifugal/centrifuge-js@2.X.X/dist/centrifuge.min.js"></script>

    <script>
      const joinGameHandler = (data) => {
        document.querySelector(
          "#update"
        ).innerHTML += `${data.name} Joined the game with ${data.permission} permissions <br/>`;
      };

      const pieceMoveHandler = (data) => {
        document.querySelector(
          "#update"
        ).innerHTML += `${data.name}: ${data.move} <br/>`;
      };

      const hookUpListeners = (ctx) => {
        if (ctx.data.event == "join_game") {
          joinGameHandler(ctx.data);
        } else if (ctx.data.event == "piece_move") {
          pieceMoveHandler(ctx.data);
        }
      };

      const centrifuge = new Centrifuge(
        "ws://localhost:8000/connection/websocket"
      );
      // keep this token somewhere safe
      centrifuge.setToken(
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NSIsImV4cCI6MTYzMTM1ODc1OH0.4c7pAxI0L242-35QYMF28mlujF9dbuZK6WRgxygrE7Q"
      );

      centrifuge.on("connect", function (ctx) {
        console.log("connected", ctx);
      });

      centrifuge.on("disconnect", function (ctx) {
        console.log("disconnected", ctx);
      });

      centrifuge.connect();

      let gameId = "";
      let playerId = "";
      let subscription;

      // new game
      document
        .getElementById("create-game")
        .addEventListener("click", async () => {
          //create a new game
          const response = await fetch("http://localhost:5050/api/createGame");
          const body = await response.json();

          // update gameId and player Id
          gameId = body.data.game_id;
          playerId = "player1";

          document.getElementById(
            "game-id"
          ).innerText = `Game Id: ${gameId}. Player: ${playerId}`;

          subscription = centrifuge.subscribe(gameId, hookUpListeners);
        });

      // // palyer sends moves to a gaming room
      document.getElementById("send-btn").addEventListener("click", () => {
        const move = document.getElementById("move-input").value;
        subscription
          .publish({
            event: "piece_move",
            permission: "READ/WRITE",
            name: playerId,
            move,
          })
          .then((res) => {})
          .catch((err) => {
            console.log("Error:", err);
          });
      });

      // // existing game
      const joinGameBtn = document.getElementById("join-game");
      const joinGameInput = document.getElementById("join-game-input");
      const okButton = document.getElementById("Ok-btn");

      joinGameBtn.addEventListener("click", () => {
        joinGameInput.style.display = "inline";
        okButton.style.display = "inline";
        joinGameBtn.style.display = "none";
      });

      okButton.addEventListener("click", () => {
        gameId = joinGameInput.value;
        playerId = "player2";

        subscription = centrifuge.subscribe(gameId, hookUpListeners);

        subscription
          .publish({
            event: "join_game",
            permission: "READ/WRITE",
            name: playerId,
          })
          .then((res) => {
            console.log("Sent: ", res);
          })
          .catch((err) => {
            console.log("Error:", err);
          });

        // reset view
        joinGameInput.style.display = "none";
        okButton.style.display = "none";
        joinGameBtn.style.display = "inline";

        // update game Id
        gameId = joinGameInput.value;
        document.getElementById(
          "game-id"
        ).innerText = `Game Id: ${gameId}. Player: ${playerId}`;
      });
    </script>
  </body>
</html>
